{% extends "lupanes/base.html" %}
{% load django_bootstrap5 %}

{% block main %}
{% if object %}
<h2>Editar albarán</h2>

{% else %}
<div class="d-flex justify-content-between">
  <h1>La compra de hoy</h1>
  <div>
    <h4 class="badge bg-success">{{ form.customer.name }}</h4>
    <a class="btn btn-link" href="#TODO-logout">salir</a>
  </div>
</div>
<table class="table">
  <thead>
    <tr>
      <th>#</th>
      <th>Producto</th>
      <th>Cantidad</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for note in deliverynotes_today %}
    <tr>
      <td>{{ forloop.counter }}</td>
      <td>{{ note.product.name }}</td>
      <td>{{ note.quantity }} {{ note.product.unit }}</td>
      <td>
        <a class="btn btn-outline-warning" href="{% url 'lupanes:deliverynote-edit' note.pk %}">editar</a>
        <a class="btn btn-outline-danger" href="{% url 'lupanes:deliverynote-delete' note.pk %}">eliminar</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<h2>Nuevo albarán</h2>
{% endif %}

<form class="form" method="post">
  {% csrf_token %}

  {% bootstrap_form form %}

  <div class="mb-3">
    <label class="form-label" for="id_unit">Unidad</label>
    <input type="text" disabled class="form-control" id="id_unit">
  </div>

  {% bootstrap_button button_type="submit" content="Enviar" %}
</form>

{% endblock main %}

{% block extra_script %}
<script>
  // TODO(@slamora): move code to a .js file
  $(document).ready(function () {
    $('#id_product').select2();

    $("#id_product").on("change", function() {
      $.getJSON(
        // TODO(@slamora): avoid hardcoded URL
        "/product/" + this.value + "/",
        function( data ) {
          $("#id_unit").val(data["unit"]["name"]);
          let step = (data["unit"]["accept_decimals"] ? "0.001" : "1");
          $("#id_quantity").attr("step", step);
        },
      );
    });
  });
</script>
{% endblock %}
